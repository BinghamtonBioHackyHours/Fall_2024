<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.45">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>varying_intercepts_varying_slopes</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="varying_intercepts_varying_slopes_files/libs/clipboard/clipboard.min.js"></script>
<script src="varying_intercepts_varying_slopes_files/libs/quarto-html/quarto.js"></script>
<script src="varying_intercepts_varying_slopes_files/libs/quarto-html/popper.min.js"></script>
<script src="varying_intercepts_varying_slopes_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="varying_intercepts_varying_slopes_files/libs/quarto-html/anchor.min.js"></script>
<link href="varying_intercepts_varying_slopes_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="varying_intercepts_varying_slopes_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="varying_intercepts_varying_slopes_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="varying_intercepts_varying_slopes_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="varying_intercepts_varying_slopes_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">




<section id="into-the-multilevel-model-varying-slopes-and-group-level-predictors" class="level1">
<h1>Into the multilevel model: Varying slopes and group level predictors</h1>
<section id="varying-intercepts" class="level3">
<h3 class="anchored" data-anchor-id="varying-intercepts">Varying Intercepts</h3>
<p>Let’s start by simulating a varying intercepts model similar to our discussion last week:</p>
<p><span class="math display">\[
\begin{align*}
y_i &amp;\sim Normal(\mu_i, \sigma_y)\\
\mu_i &amp;= \alpha_{j[i]} + \beta x_i\\
\alpha_j &amp;\sim Normal(\overline{\alpha}, \sigma_{\alpha})
\end{align*}
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">10</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">200</span> <span class="co"># number of observations</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>j <span class="ot">&lt;-</span> <span class="dv">10</span> <span class="co"># number of groups</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>a_bar <span class="ot">&lt;-</span> .<span class="dv">5</span> <span class="co"># mean of intercepts</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> .<span class="dv">5</span> <span class="co"># slope</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>sigma_a <span class="ot">&lt;-</span> .<span class="dv">75</span> <span class="co"># error standard deviation of the intercept</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>sigma_y <span class="ot">&lt;-</span> <span class="fl">1.1</span> <span class="co"># individual level error standard deviation</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>group <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>j, n, <span class="at">replace =</span> T) <span class="co"># assign individuals to groups</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(j, <span class="at">mean =</span> a_bar, <span class="at">sd =</span> sigma_a) <span class="co"># sample j intercepts</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n) <span class="co"># sample n predictor values</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> a[group] <span class="sc">+</span> b <span class="sc">*</span> x <span class="co"># calculate the conditional means</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, mu, sigma_y) <span class="co"># add noise to the prediction.</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>x_pred <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="dv">3</span>,<span class="at">l =</span> <span class="dv">100</span>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(y <span class="sc">~</span> x, <span class="at">pch =</span> <span class="dv">19</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>j) <span class="fu">lines</span>((a[i] <span class="sc">+</span> b<span class="sc">*</span>x_pred) <span class="sc">~</span> x_pred, <span class="at">col =</span> <span class="st">"grey"</span>)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(a_bar <span class="sc">+</span> x_pred<span class="sc">*</span>b <span class="sc">~</span> x_pred, <span class="at">col =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="varying_intercepts_varying_slopes_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Let’s fit a varying intercepts model to this data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(arm)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>grp <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(group)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>mod1 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(y <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> x <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>grp))</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span>(mod1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>lmer(formula = y ~ 1 + x + (1 | grp))
            coef.est coef.se
(Intercept) 0.75     0.17   
x           0.45     0.07   

Error terms:
 Groups   Name        Std.Dev.
 grp      (Intercept) 0.48    
 Residual             1.08    
---
number of obs: 200, groups: grp, 10
AIC = 626.2, DIC = 607.7
deviance = 613.0 </code></pre>
</div>
</div>
<p>So the model has point estimates of <span class="math inline">\(\overline{\alpha} = .75 \pm .34\)</span>, <span class="math inline">\(\beta = .45 \pm .14\)</span>, <span class="math inline">\(\sigma_y = 1.08\)</span>, <span class="math inline">\(\sigma_{\alpha} = .48\)</span>. This all is pretty close to our simulated values.</p>
</section>
<section id="intro-to-varying-intercepts-and-varying-slopes" class="level2">
<h2 class="anchored" data-anchor-id="intro-to-varying-intercepts-and-varying-slopes">Intro to varying intercepts and varying slopes</h2>
<p>It would be nice if we could just add an independent model: <span class="math inline">\(\beta_j \sim Normal(\overline{\beta}, \sigma_{\beta})\)</span>. Unfortunately, we are not so lucky. We could do this if we expect <span class="math inline">\(\alpha_j\)</span> and <span class="math inline">\(\beta_j\)</span> to be uncorrelated, but they will often be correlated, so we need to account for this. In this case, we will use the multi-variate normal distribution to model the coefficients. Deep breaths, here we go:</p>
<p><span class="math display">\[
\begin{align*}
y_i &amp;\sim Normal(\mu_i, \sigma_y)\\
\mu_i &amp;= \alpha_{j[i]} + \beta_{j[i]} x_i\\
\begin{bmatrix} \alpha_j \\ \beta_j \end{bmatrix} &amp;\sim MVN(\begin{bmatrix} \overline{\alpha}\\\overline{\beta}\end{bmatrix}, \Sigma)\\
\Sigma &amp;= \begin{bmatrix} \sigma_{\alpha}^2 \space \space \rho\sigma_{\alpha}\sigma_{\beta} \\ \rho\sigma_{\alpha}\sigma_{\beta} \space  \space \sigma_{\beta}^2\end{bmatrix}
\end{align*}
\]</span></p>
<p>Always be simulatin’!. The big new thing here is that now the coefficients are allowed to co-vary. The strength of this covariance is controlled by <span class="math inline">\(\rho\)</span>, or the correlation. Let’s simulate a bunch of <span class="math inline">\(\alpha\)</span>’s and <span class="math inline">\(\beta\)</span>’s with different values of <span class="math inline">\(\rho\)</span>. Because correlation is easier to understand than covariance and standard deviations are easier to understand than variances, we will break down the covariance matrix above into: <span class="math inline">\(\Sigma = SRS\)</span>, where <span class="math inline">\(S\)</span> is a diagonal matrix with the standard deviations of the coefficients on the diagonal and 0’s everywhere else, and <span class="math inline">\(R\)</span> is a correlation matrix with 1’s on the diagonal and correlations elsewhere:</p>
<p><span class="math display">\[
\Sigma = \begin{bmatrix} \sigma_{\alpha} \space 0 \\ 0 \space \sigma_{\beta} \end{bmatrix}\begin{bmatrix} 1 \space \rho\\ \rho \space 1 \end{bmatrix}\begin{bmatrix} \sigma_{\alpha} \space 0 \\ 0 \space \sigma_{\beta} \end{bmatrix}
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>coef_sims <span class="ot">&lt;-</span> <span class="cf">function</span>(rho){</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  a_bar <span class="ot">&lt;-</span> .<span class="dv">5</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  b_bar <span class="ot">&lt;-</span> .<span class="dv">5</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  sig_a <span class="ot">&lt;-</span> <span class="fl">1.1</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  sig_b <span class="ot">&lt;-</span> <span class="fl">1.5</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  rho <span class="ot">&lt;-</span> rho</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  S <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="fu">c</span>(sig_a, sig_b))</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  R <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, rho, rho, <span class="dv">1</span>), <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  a_b <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(n, <span class="fu">c</span>(a_bar, b_bar), S <span class="sc">%*%</span> R <span class="sc">%*%</span> S)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(a_b[,<span class="dv">1</span>] <span class="sc">~</span> a_b[,<span class="dv">2</span>])</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="fu">coef_sims</span>(<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="varying_intercepts_varying_slopes_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef_sims</span>(.<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="varying_intercepts_varying_slopes_files/figure-html/unnamed-chunk-3-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef_sims</span>(.<span class="dv">75</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="varying_intercepts_varying_slopes_files/figure-html/unnamed-chunk-3-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef_sims</span>(<span class="sc">-</span>.<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="varying_intercepts_varying_slopes_files/figure-html/unnamed-chunk-3-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef_sims</span>(<span class="sc">-</span>.<span class="dv">75</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> .<span class="dv">5</span> <span class="sc">-</span> .<span class="dv">5</span><span class="sc">*-</span>.<span class="dv">75</span><span class="sc">*</span><span class="fl">1.1</span><span class="sc">/</span><span class="fl">1.5</span>, <span class="at">b =</span> <span class="sc">-</span>.<span class="dv">75</span><span class="sc">*</span><span class="fl">1.1</span><span class="sc">*</span><span class="fl">1.5</span><span class="sc">/</span>(<span class="fl">1.5</span><span class="sc">^</span><span class="dv">2</span>), <span class="at">col =</span> <span class="st">"blue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="varying_intercepts_varying_slopes_files/figure-html/unnamed-chunk-3-5.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef_sims</span>(<span class="dv">1</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> .<span class="dv">5</span> <span class="sc">-</span> .<span class="dv">5</span><span class="sc">*</span><span class="fl">1.1</span><span class="sc">/</span><span class="fl">1.5</span>, <span class="at">b =</span> <span class="dv">1</span><span class="sc">*</span><span class="fl">1.1</span><span class="sc">*</span><span class="fl">1.5</span><span class="sc">/</span>(<span class="fl">1.5</span><span class="sc">^</span><span class="dv">2</span>), <span class="at">col =</span> <span class="st">"blue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="varying_intercepts_varying_slopes_files/figure-html/unnamed-chunk-3-6.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>So let’s go ahead and simulate a varying slopes and varying intercepts data generating process and fit it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>a_bar <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>b_bar <span class="ot">&lt;-</span> .<span class="dv">5</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>sig_a <span class="ot">&lt;-</span> .<span class="dv">75</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>sig_b <span class="ot">&lt;-</span> <span class="fl">1.1</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>sig_y <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>rho <span class="ot">&lt;-</span> .<span class="dv">5</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>S <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="fu">c</span>(sig_a, sig_b))</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>R <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, rho, rho, <span class="dv">1</span>), <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>a_b <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(<span class="dv">20</span>, <span class="fu">c</span>(a_bar, b_bar), S <span class="sc">%*%</span> R <span class="sc">%*%</span> S)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>group <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>, n, <span class="at">replace =</span> T)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> a_b[group, <span class="dv">1</span>] <span class="sc">+</span> a_b[group, <span class="dv">2</span>] <span class="sc">*</span> x</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, mu, sig_y)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(y <span class="sc">~</span> x, <span class="at">pch =</span> <span class="dv">19</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="varying_intercepts_varying_slopes_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Kinda hard to see what’s going on, let’s plot all the groups.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.5.1
✔ ggplot2   3.5.1     ✔ tibble    3.2.1
✔ lubridate 1.9.3     ✔ tidyr     1.3.1
✔ purrr     1.0.2     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ tidyr::expand() masks Matrix::expand()
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
✖ tidyr::pack()   masks Matrix::pack()
✖ dplyr::select() masks MASS::select()
✖ tidyr::unpack() masks Matrix::unpack()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(y, x, group) <span class="sc">%&gt;%</span> </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(group <span class="sc">~</span> .)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="varying_intercepts_varying_slopes_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now let’s fit the model with <code>lmer</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>grp <span class="ot">&lt;-</span> <span class="fu">factor</span>(group)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>mod2 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(y <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> x <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> x<span class="sc">|</span>grp))</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span>(mod2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>lmer(formula = y ~ 1 + x + (1 + x | grp))
            coef.est coef.se
(Intercept) -0.30     0.16  
x            0.22     0.28  

Error terms:
 Groups   Name        Std.Dev. Corr 
 grp      (Intercept) 0.61          
          x           1.18     0.56 
 Residual             0.97          
---
number of obs: 200, groups: grp, 20
AIC = 645.2, DIC = 627.4
deviance = 630.3 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>fits <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">group =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>, <span class="at">a =</span> <span class="fu">coef</span>(mod2)<span class="sc">$</span>grp[,<span class="dv">1</span>], <span class="at">b =</span> <span class="fu">coef</span>(mod2)<span class="sc">$</span>grp[,<span class="dv">2</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s plot the mean fits on the data</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(y, x, group) <span class="sc">%&gt;%</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(group <span class="sc">~</span> .) <span class="sc">+</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"grey"</span>) <span class="sc">+</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"grey"</span>) <span class="sc">+</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">data =</span> fits, <span class="fu">aes</span>(<span class="at">slope =</span> b, <span class="at">intercept =</span> a))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="varying_intercepts_varying_slopes_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="adding-group-level-predictors" class="level2">
<h2 class="anchored" data-anchor-id="adding-group-level-predictors">Adding Group Level Predictors</h2>
<p>Let’s load in the plant germination data to play around with some real data. Let’s plot it to see what it looks like. There are many things that we might be interested about in this data set. Let’s start off by trying to estimate growth rates. In this case, growth rate will be the regression coefficient on age.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>here() starts at C:/Users/jjk06/OneDrive/Desktop/Fall_2024</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>growth_dat <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">here</span>(<span class="st">"data/week_10/plant_growth.csv"</span>))</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(growth_dat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   id   seed_size   size age
1 1_1  0.04398394  1.915   1
2 1_1  0.04398394  4.016   3
3 1_1  0.04398394  7.821   6
4 1_2 -0.01040480  3.133   1
5 1_2 -0.01040480  5.999   3
6 1_2 -0.01040480 15.602   6</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>growth_dat <span class="sc">%&gt;%</span> </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> size)) <span class="sc">+</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="varying_intercepts_varying_slopes_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Looks like exponential growth. We could probably use a log-normal GLMM, but let’s transform it for fun.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>growth_dat<span class="sc">$</span>l_size <span class="ot">&lt;-</span> <span class="fu">log</span>(growth_dat<span class="sc">$</span>size)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>growth_dat <span class="sc">%&gt;%</span> </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> l_size)) <span class="sc">+</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="varying_intercepts_varying_slopes_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>It looks nice and linear now! So let’s do some modeling. It is probably a bad idea to completely pool this data since multiple measures were taken for each individual. So we will use a multilevel model (partial pooling) to get at the variation between individuals. Let’s fit no-pool model as well and compare the intercepts</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>growth_dat<span class="sc">$</span>id <span class="ot">&lt;-</span> <span class="fu">factor</span>(growth_dat<span class="sc">$</span>id)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>mod_p_pool <span class="ot">&lt;-</span> <span class="fu">lmer</span>(l_size <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> age <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> age<span class="sc">|</span>id), <span class="at">data =</span> growth_dat)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>mod_no_pool <span class="ot">&lt;-</span> <span class="fu">lm</span>(l_size <span class="sc">~</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> age <span class="sc">+</span> id <span class="sc">+</span> id<span class="sc">*</span>age, <span class="at">data =</span> growth_dat)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(mod_p_pool)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$id
     (Intercept)        age
1_1   0.48549775 0.26725768
1_10  0.72556673 0.30280747
1_11  0.49179495 0.29185197
1_12  0.65888082 0.25166042
1_13  0.08988111 0.28554479
1_14  0.67811242 0.28150616
1_15  0.23063808 0.28525350
1_16  1.07514468 0.26523973
1_17  0.73613991 0.27334570
1_18  0.75198377 0.27475451
1_19  0.96753869 0.24380945
1_2   0.86943876 0.30646593
1_20  0.72789964 0.26627216
1_22  0.95631262 0.17951389
1_23  0.43164622 0.27505914
1_24  0.68791453 0.08587145
1_27  0.63672506 0.28997290
1_28  0.59491649 0.27573163
1_29  0.95015708 0.26804459
1_3   0.73141207 0.29036888
1_30  0.71109477 0.29458840
1_32  0.65894892 0.20354316
1_34  0.70244452 0.29322823
1_35  0.34325162 0.31259412
1_38  0.69204912 0.27888749
1_39  0.77199242 0.30682060
1_40  0.71368335 0.25759533
1_41  0.35756139 0.26277240
1_44  0.46779832 0.17593475
1_46  0.61662855 0.27797074
1_48  0.65677645 0.23790192
1_49  0.70941964 0.28029488
1_50  0.29335856 0.28117463
1_52  0.70804854 0.22837642
1_53  0.81983949 0.24375136
1_54  0.58823343 0.28964535
1_55  0.94978342 0.28416493
1_56  0.96801701 0.27498733
1_58  0.79257352 0.27354490
1_59  0.84915314 0.30006346
1_6   0.83256562 0.30759232
1_60  0.72398980 0.27097432
1_63 -0.03845211 0.25292917
1_64  0.49862652 0.15476438
1_65  0.95456331 0.27203259
1_66  0.16509182 0.26613710
1_67  0.81001419 0.25205441
1_68  0.80147881 0.16139880
1_69  0.32538224 0.28401747
1_7   0.16954461 0.31824359
1_70  0.69002067 0.29237638
1_71  0.71573316 0.26088145
1_72  0.74700430 0.24289283
1_73  0.56366859 0.27647813
1_74  0.45168743 0.25822445
1_75  0.98246514 0.27530121
1_76  0.72934016 0.24392721
1_77  0.80070090 0.20170997
1_78  0.67508720 0.27483042
1_8   0.84412511 0.19750616
1_80  0.51782184 0.28041166
1_9   0.72510406 0.30523551
2_1   0.23661032 0.27283272
2_11  0.86973202 0.26198592
2_12  0.36503533 0.30105954
2_13  0.47811421 0.30917515
2_14  0.95139647 0.29838230
2_17  0.49364954 0.26604083
2_18  0.67417852 0.30180801
2_21  0.98532710 0.29182268
2_22  0.73794546 0.32088447
2_23  0.88203927 0.27542599
2_24  0.79581678 0.28751875
2_26  0.50175447 0.30976614
2_27  0.64213352 0.29020559
2_28  0.74836192 0.27592092
2_29  0.86713383 0.29738734
2_3   0.99880788 0.28153115
2_30  0.43137666 0.31046431
2_31  0.77843350 0.28083109
2_33  0.61730561 0.31374919
2_34  0.84270332 0.30309842
2_35 -0.24739896 0.11429439
2_36  0.61385119 0.11815428
2_37  0.82231619 0.28747344
2_39  0.35179229 0.24828932
2_41  0.65131300 0.31459328
2_42  0.72162964 0.30062375
2_43  1.09521138 0.24751551
2_45  0.58586326 0.32275610
2_46  0.91097540 0.29145530
2_47  0.75899444 0.24617937
2_48  0.62452935 0.32228436
2_51  0.75384564 0.32167773
2_52  0.86382636 0.27527591
2_53  0.73231682 0.26985530
2_54  0.99531502 0.27429887
2_56  0.69829617 0.19212047
2_57  0.22016757 0.24480711
2_58  1.03515846 0.27057370
2_59  0.93977477 0.18455253
2_62  0.62228348 0.26383045
2_63  0.93008865 0.20027129
2_64  0.46612698 0.24520892
2_65  0.99258217 0.21782940
2_67  1.00405872 0.31304094
2_68  0.90932512 0.28260438
2_69  0.76551004 0.30139165
2_7   0.64803719 0.30338894
2_70  0.86790073 0.31557817
2_76  0.29875324 0.26300339
2_77  0.15560088 0.09257199
2_78  0.83288486 0.29933173
2_79  0.66487395 0.31067439
2_9   0.79538318 0.32253234

attr(,"class")
[1] "coef.mer"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>fit_no_pool <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">coef</span>(mod_no_pool)[<span class="dv">2</span><span class="sc">:</span><span class="dv">116</span>])</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>fit_p_pool <span class="ot">&lt;-</span> <span class="fu">coef</span>(mod_p_pool)<span class="sc">$</span>id[,<span class="dv">1</span>]</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit_no_pool, <span class="at">pch =</span> <span class="dv">19</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(fit_p_pool, <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">ylab =</span> <span class="st">"Intercept"</span>, <span class="at">pch =</span> <span class="dv">19</span>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="fu">fixef</span>(mod_p_pool)[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="varying_intercepts_varying_slopes_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Notice how the</p>
<section id="adding-a-group-level-predictor-to-the-intercept" class="level3">
<h3 class="anchored" data-anchor-id="adding-a-group-level-predictor-to-the-intercept">Adding a group level predictor to the intercept</h3>
<p>So this is doing what we want, shrinking the intercepts toward the group mean to help overfitting and use as much information as we can reasonably use. But there is a variable we haven’t considered yet. Seed size is likely a major factor in the size of a seedling at time 0 (i.e.&nbsp;the intercept). Let’s try a varying intercepts model where the intercept is a function of seed size. We want a model that looks like:</p>
<p><span class="math display">\[
\begin{align*}
size_{i} &amp;\sim Normal(\mu_{i}, \sigma_{size})\\
\mu_i &amp;= \alpha_{j[i]} + rate\times age_i\\
\alpha_{j} &amp;\sim Normal(\overline{\alpha} + \gamma_{\alpha} \times seedsize_{j}, \sigma_{\alpha})
\end{align*}
\]</span></p>
<p>How do we get this into <code>lmer</code> though? Well, if we remember that this form of the model of <span class="math inline">\(\alpha_j\)</span> is just a re-writing of the form:</p>
<p><span class="math display">\[
\begin{align*}
\alpha_j &amp;= \overline{\alpha} + \gamma_{\alpha} \times seedsize_j + \eta_j\\
\eta_j &amp;\sim Nomral(0, \sigma_{\alpha})
\end{align*}
\]</span> We can plug this definition of <span class="math inline">\(\alpha_j\)</span> into the level one equation:</p>
<p><span class="math display">\[
\begin{align*}
\mu_i &amp;= (\overline{\alpha} + \gamma_{\alpha} \times seedsize_j + \eta_j) + rate\times age_i\\
\end{align*}
\]</span> So, in <code>lmer</code> it becomes: <code>lmer(l_size ~ 1 + seed_size + age + (1|id))</code>. Let’s try it out.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>mod_seed_int <span class="ot">&lt;-</span> <span class="fu">lmer</span>(l_size <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> seed_size <span class="sc">+</span> age <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>id), <span class="at">data =</span> growth_dat)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span>(mod_seed_int)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>lmer(formula = l_size ~ 1 + seed_size + age + (1 | id), data = growth_dat)
            coef.est coef.se
(Intercept) 0.63     0.04   
seed_size   0.07     0.03   
age         0.28     0.00   

Error terms:
 Groups   Name        Std.Dev.
 id       (Intercept) 0.36    
 Residual             0.22    
---
number of obs: 562, groups: id, 115
AIC = 203.8, DIC = 153.2
deviance = 173.5 </code></pre>
</div>
</div>
<p>Let’s plot the model for the group level intercepts! This might take some <strong>wrangling</strong>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>seed_size <span class="ot">&lt;-</span> <span class="fu">unique</span>(growth_dat[,<span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"seed_size"</span>)])</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>sims <span class="ot">&lt;-</span> <span class="fu">sim</span>(mod_seed_int, <span class="dv">1000</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>rans <span class="ot">&lt;-</span> <span class="fu">t</span>(sims<span class="sc">@</span>ranef<span class="sc">$</span>id[,,<span class="dv">1</span>])</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>ints <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> <span class="dv">115</span>, <span class="at">ncol =</span> <span class="dv">1000</span>)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>){</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  ints[,i] <span class="ot">&lt;-</span> <span class="fu">exp</span>(rans[,i] <span class="sc">+</span> sims<span class="sc">@</span>fixef[i,<span class="dv">1</span>] <span class="sc">+</span> seed_size<span class="sc">$</span>seed_size <span class="sc">*</span> sims<span class="sc">@</span>fixef[i,<span class="dv">2</span>])</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>ints <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(ints)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">mu =</span> <span class="fu">apply</span>(ints, <span class="dv">1</span>, mean), <span class="at">upr =</span> <span class="fu">apply</span>(ints, <span class="dv">1</span>, quantile, .<span class="dv">975</span>), <span class="at">lwr =</span> <span class="fu">apply</span>(ints, <span class="dv">1</span>, quantile, .<span class="dv">025</span>), <span class="at">seed_size =</span> seed_size<span class="sc">$</span>seed_size, <span class="at">id =</span> seed_size<span class="sc">$</span>id)</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>seed_pred <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="dv">3</span>,<span class="at">l =</span> <span class="dv">100</span>)</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>int_pred <span class="ot">&lt;-</span> int_upr <span class="ot">&lt;-</span> int_lwr <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>){</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>  temp <span class="ot">&lt;-</span> sims<span class="sc">@</span>fixef[,<span class="dv">1</span>] <span class="sc">+</span> sims<span class="sc">@</span>fixef[,<span class="dv">2</span>] <span class="sc">*</span> seed_pred[i]</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>  int_pred[i] <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fu">mean</span>(temp))</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>  int_upr[i] <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fu">quantile</span>(temp, .<span class="dv">975</span>))</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>  int_lwr[i] <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fu">quantile</span>(temp, .<span class="dv">025</span>))</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(seed_pred, int_pred, int_upr, int_lwr) <span class="sc">%&gt;%</span> </span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> seed_pred, <span class="at">y =</span> int_pred)) <span class="sc">+</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">x =</span> seed_pred, <span class="at">ymax =</span> int_upr, <span class="at">ymin =</span> int_lwr), <span class="at">alpha =</span> .<span class="dv">25</span>) <span class="sc">+</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> z, <span class="fu">aes</span>(<span class="at">x =</span> seed_size, <span class="at">y =</span> mu)) <span class="sc">+</span></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">data =</span> z, <span class="fu">aes</span>(<span class="at">x =</span> seed_size, <span class="at">ymax =</span> upr, <span class="at">ymin =</span> lwr), <span class="at">inherit.aes =</span> F,</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>                <span class="at">width =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="varying_intercepts_varying_slopes_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="adding-group-level-predictors-to-the-slope-or-group-level-predictors-as-interactions." class="level3">
<h3 class="anchored" data-anchor-id="adding-group-level-predictors-to-the-slope-or-group-level-predictors-as-interactions.">Adding group level predictors to the slope: or, group level predictors as interactions.</h3>
<p>How to add group level predictors to the slope using <code>lmer</code> is not intuitive–to me at least. But I think it is helpful to view adding these predictors as creating an interaction between the group level predictor, and the individual level predictor. This helps me think about statistical interactions. I.E. the “main effect” is the mean slope on the individual level predictor and the slope on the interaction adjusts the slope for each group. Let’s build this up.</p>
<p><span class="math display">\[
\begin{align*}
y_i &amp;\sim Normal(\mu_i, \sigma_y)\\
\mu_i &amp;= \alpha_{j[i]} + \beta_{j[i]} x_i\\
\begin{bmatrix} \alpha_j \\ \beta_j \end{bmatrix} &amp;= MVNormal(\begin{bmatrix} \overline{\alpha} + \gamma_{\alpha} u_j \\ \overline{\beta} + \gamma_{\beta} u_j \end{bmatrix}, \Sigma)
\end{align*}
\]</span></p>
<p>So, now we hvae our individual level predictor, <span class="math inline">\(x\)</span> and our group level predictor, <span class="math inline">\(u\)</span>. To see how we can use <code>lmer</code> to do this, we can stick our linear models for the intercept and slope into the single level model:</p>
<p><span class="math display">\[
\begin{align*}
\mu_i &amp;= \alpha_{j[i]} + \beta_{j[i]} x_i\\
&amp;= (\overline{\alpha} + \gamma_{\alpha} u_{i[j]}) + (\overline{\beta} + \gamma_{\beta} u_{j[i]}) x_i\\
&amp;= \overline{\alpha} + \gamma_{\alpha} u_{j[i]} + \overline{\beta} x_i + \gamma_{\beta} u_{j[i]}x_i
\end{align*}
\]</span></p>
<p>This gives us the formula we can use: <code>lmer(y ~ 1 + u + x + u*x + (1 + x|group))</code>. Pretty cool! Let’s fit this model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>mod_var_ints_slopes <span class="ot">&lt;-</span> <span class="fu">lmer</span>(l_size <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> seed_size <span class="sc">+</span> age <span class="sc">+</span> seed_size<span class="sc">*</span>age <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> age<span class="sc">|</span>id), <span class="at">data =</span> growth_dat)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span>(mod_var_ints_slopes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>lmer(formula = l_size ~ 1 + seed_size + age + seed_size * age + 
    (1 + age | id), data = growth_dat)
              coef.est coef.se
(Intercept)   0.67     0.02   
seed_size     0.07     0.02   
age           0.27     0.00   
seed_size:age 0.00     0.00   

Error terms:
 Groups   Name        Std.Dev. Corr 
 id       (Intercept) 0.25          
          age         0.05     0.07 
 Residual             0.11          
---
number of obs: 562, groups: id, 115
AIC = -150, DIC = -223.7
deviance = -194.9 </code></pre>
</div>
</div>
<p>Let’s sort out this output in terms of our varying intercepts, varying slopes model with predictors. First a reminder of the model: <span class="math display">\[
\begin{align*}
y_i &amp;\sim Normal(\mu_i, \sigma_y)\\
\mu_i &amp;= \alpha_{j[i]} + \beta_{j[i]} x_i\\
\begin{bmatrix} \alpha_j \\ \beta_j \end{bmatrix} &amp;\sim MVN(\begin{bmatrix} \overline{\alpha} + \gamma_{\alpha} u_j \\ \overline{\beta} + \gamma_{\beta} u_j\end{bmatrix}, \Sigma)\\
\Sigma &amp;= \begin{bmatrix} \sigma_{\alpha}^2 \space \space \rho\sigma_{\alpha}\sigma_{\beta} \\ \rho\sigma_{\alpha}\sigma_{\beta} \space  \space \sigma_{\beta}^2\end{bmatrix}
\end{align*}
\]</span> Let’s fill it in with our model output:</p>
<p><span class="math display">\[
\begin{align*}
\log(size_i) &amp;\sim Normal(\space\mu_i,\space .11)\\
\mu_i &amp;= \alpha_{j[i]} + \beta_{j[i]} x_i\\
\begin{bmatrix} \alpha_j \\ \beta_j \end{bmatrix} &amp;\sim MVN(\begin{bmatrix} .67 + .07 \times seedsize_j \\ .27 + 0\times seedsize_j\end{bmatrix}, \Sigma)\\
\Sigma &amp;= \begin{bmatrix} .25^2 \space \space \space .07\times .25\times .05 \\ .07\times .25\times .05 \space \space  \space .05^2\end{bmatrix}
\end{align*}
\]</span></p>
<p>And that’s our multilevel model. We have slopes and intercepts that vary by individual plant and we have group level predictors that let us potentially get better resolution on what drives variation between groups, which is something that we can’t do without partial pooling!</p>
</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>